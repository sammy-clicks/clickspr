<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Clicks Beta Map</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Bebas+Neue&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    #map { width:100%; height:100vh }

    /* Popup styling */
    .map-popup {
      font-size: 14px;
      line-height: 1.4;
      background: #1f2126;
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      max-width: 240px;
    }
    .map-popup .pick-badge {
      display: block;
      width: 100%;
      background: #00c853; /* green */
      color: #fff;
      font-weight: bold;
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 4px;
      margin-bottom: 8px;
      text-align: center;
    }
    .map-popup b {
      display: block;
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .map-popup .venue-meta {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .map-popup .venue-extra {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 8px;
    }
    .map-popup button {
      display: inline-block;
      width: 100%;
      background: #ff5a5f;
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }
    .map-popup button:hover {
      background: #e0484e;
    }
  </style>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="media-config.js"></script>
</head>
<body>

<header class="header">
  <div class="brand">
    <img src="Media/logo.png" alt="Clicks Logo">
    <a href="index.html" class="name-link">
      <div class="name">CLICKS <span class="beta">beta</span></div>
    </a>
  </div>
</header>
<div class="version-tag">v0.7.2</div>

<div id="map"></div>

<script>
// Fetch venues from server
async function loadVenues(){
  try {
    const res = await fetch("/api/venues");
    if(!res.ok) throw new Error("Failed to load venues");
    let venues = await res.json();

    // Ensure lat/lng are numbers
    venues.forEach(v=>{
      if(typeof v.lat==="string"){ const n=parseFloat(v.lat); if(!Number.isNaN(n)) v.lat=n; }
      if(typeof v.lng==="string"){ const n=parseFloat(v.lng); if(!Number.isNaN(n)) v.lng=n; }
    });

    renderMap(venues);
  } catch(err){
    console.error(err);
    alert("Could not load venues from server.");
  }
}

function renderMap(venues){
  // Init map centered in San Juan
  const map=L.map('map').setView([18.4655,-66.1057],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap' }).addTo(map);

  // Marker styles (CSS divIcons)
  const defaultIcon = L.divIcon({
    className: 'marker-normal',
    iconSize: [18,18],
    popupAnchor: [0,-9]
  });

  const pickIcon = L.divIcon({
    className: 'marker-pick',
    iconSize: [20,20],
    popupAnchor: [0,-10]
  });

  // Store markers for later lookup
  let markers = [];

  // Drop pins
  venues.forEach(v=>{
    if(typeof v.lat==="number" && typeof v.lng==="number" && !Number.isNaN(v.lat) && !Number.isNaN(v.lng)){
      const icon = v.isPick ? pickIcon : defaultIcon;
      const popupHtml = `
        <div class="map-popup">
          ${v.isPick ? `<div class='pick-badge'>Pick of the Week</div>` : ""}
          <a href="#" class="venue-popup-link" data-venue-id="${v.id}" style="color:#FFD75E;text-decoration:underline;font-weight:700;">${v.name||""}</a>
          <div class="venue-meta">${v.zone||""} • ${v.price||""}</div>
          <div class="venue-extra">${v.category||"Bar"} • ${v.clicks||0} clicks</div>
          <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${v.lat},${v.lng}','_blank')">
            Get Directions
          </button>
        </div>
      `;
      const marker = L.marker([v.lat,v.lng], { icon }).addTo(map).bindPopup(popupHtml);
      markers.push({marker, v});
    }
  });

  // Focus if passed from modal (auto open popup)
  try {
    const f=JSON.parse(sessionStorage.getItem("map_focus")||"null");
    if(f && typeof f.lat==="number" && typeof f.lng==="number"){
      map.setView([f.lat,f.lng],17);
      // Find matching marker with tolerance
      const match = markers.find(m =>
        Math.abs(m.v.lat - f.lat) < 0.0001 &&
        Math.abs(m.v.lng - f.lng) < 0.0001 &&
        (!f.name || m.v.name === f.name)
      );
      if(match) match.marker.openPopup();
      sessionStorage.removeItem("map_focus");
    }
  }catch(e){}
}

// Listen for venue name clicks in popups
document.addEventListener('click', function(e) {
  const link = e.target.closest('.venue-popup-link');
  if (link) {
    e.preventDefault();
    const venueId = link.getAttribute('data-venue-id');
    // Store venue ID in sessionStorage and redirect to index.html
    sessionStorage.setItem('openVenueId', venueId);
    window.location.href = 'index.html';
  }
});

// Run it
loadVenues();
</script>

<style>
/* Make brand title look clickable */
.name-link { text-decoration: none; color: inherit; }
.name-link:hover .name { text-decoration: underline; cursor: pointer; }
</style>

</body>
</html>
